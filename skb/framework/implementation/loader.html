<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7 at 2019-05-09 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20190509" />
    <meta http-equiv="Content-Language" content="en" />
    <title>SKB-FRAMEWORK &#x2013; Implementation: loader</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />

      
    <script type="text/javascript" src="../js/apache-maven-fluido-1.5.min.js"></script>

          <link href="https://fonts.googleapis.com/css?family=Lora|Roboto+Condensed" rel="stylesheet" />
                      </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2></h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                              <li class="">
                    <a href="http://www.vandermeer.de/" class="externalLink" title="vdmeer">
        vdmeer</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="https://vdmeer.github.io/skb/" class="externalLink" title="skb">
        skb</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="../index.html" title="framework">
        framework</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Implementation: loader</li>
        
              
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2019-05-09</li>
              <li id="projectVersion" class="pull-right">
                    Version: 0.0.3
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">SKB FRAMEWORK</li>
                              
      <li>
  
                          <a href="../index.html" title="Welcome">
          <span class="none"></span>
        Welcome</a>
            </li>
                                                                                                                                                                        
      <li>
  
                          <a href="../manual.html" title="Manual">
          <span class="icon-chevron-down"></span>
        Manual</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="../manual/options.html" title="Options">
          <span class="none"></span>
        Options</a>
            </li>
                    
      <li>
  
                          <a href="../manual/parameters.html" title="Parameters">
          <span class="none"></span>
        Parameters</a>
            </li>
                    
      <li>
  
                          <a href="../manual/tasks.html" title="Tasks">
          <span class="none"></span>
        Tasks</a>
            </li>
                    
      <li>
  
                          <a href="../manual/dependencies.html" title="Dependencies">
          <span class="none"></span>
        Dependencies</a>
            </li>
                    
      <li>
  
                          <a href="../manual/commands.html" title="Commands">
          <span class="none"></span>
        Commands</a>
            </li>
                    
      <li>
  
                          <a href="../manual/scenarios.html" title="Scenarios">
          <span class="none"></span>
        Scenarios</a>
            </li>
                    
      <li>
  
                          <a href="../manual/exit-status.html" title="Exit Status">
          <span class="none"></span>
        Exit Status</a>
            </li>
              </ul>
        </li>
                
      <li>
  
                          <a href="../user-guide.html" title="User Guide">
          <span class="none"></span>
        User Guide</a>
            </li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
      <li>
  
                          <a href="../task-guide.html" title="Task Guide">
          <span class="icon-chevron-down"></span>
        Task Guide</a>
                    <ul class="nav nav-list">
                                                                                                                                                                                                                                                                                                                
      <li>
  
                          <a href="../task-guide/use-tasks.html" title="Use Tasks">
          <span class="icon-chevron-right"></span>
        Use Tasks</a>
                  </li>
                                                                                                          
      <li>
  
                          <a href="../task-guide/build-tasks.html" title="Build Tasks">
          <span class="icon-chevron-right"></span>
        Build Tasks</a>
                  </li>
                                                                                                                            
      <li>
  
                          <a href="../task-guide/dev-tasks.html" title="Development Tasks">
          <span class="icon-chevron-right"></span>
        Development Tasks</a>
                  </li>
              </ul>
        </li>
                                                                                                                                                                                                                                                                        
      <li>
  
                          <a href="../developer-guide.html" title="Developer Guide">
          <span class="icon-chevron-down"></span>
        Developer Guide</a>
                    <ul class="nav nav-list">
                                                                                                                                                                                                                                                          
      <li>
  
                          <a href="../developer-guide/api.html" title="API">
          <span class="icon-chevron-right"></span>
        API</a>
                  </li>
              </ul>
        </li>
                                                                                                          
      <li>
  
                          <a href="../implementation.html" title="The Implementation">
          <span class="icon-chevron-down"></span>
        The Implementation</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="../implementation/skb-framework.html" title="skb-framework">
          <span class="none"></span>
        skb-framework</a>
            </li>
                    
      <li class="active">
  
            <a href="#"><span class="none"></span>loader</a>
          </li>
                    
      <li>
  
                          <a href="../implementation/shell.html" title="shell">
          <span class="none"></span>
        shell</a>
            </li>
              </ul>
        </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                                                                                                                         <a href="https://maven.apache.org/plugins/maven-site-plugin" title="maven-site" class="builtBy">
        <img class="builtBy"  alt="maven-site" src="../images/logos/build-by-maven-black.png"    />
      </a>
                                                                                                          <a href="https://asciidoctor.org" title="asciidoctor" class="builtBy">
        <img class="builtBy"  alt="asciidoctor" src="../images/logos/asciidoctor-transparent.png"    />
      </a>
                      </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <div class="sect1">
<h2 id="the_loader">The Loader</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The loader is the script <code>$FW_HOME/bin/loader/loader.sh</code>.
It is responsible for all initial configuration, loading elements, testing settings and dependencies, processing command line arguments (options), and execute task, scenarios, or the shell.
The load process has multiple steps, starting with some initial settings and finished with a cleanup.</p>
</div>
<div class="paragraph">
<p>The initial settings are shown in the source block below.
Line 1 restricts <em>bash</em>, providing a safer execution environment.
Line 2 allows for extended globbing (finding files recursively with wildecards such as <code><strong>*/</strong>.adoc</code>).
Line 3 takes the current time.
This information is later used to calculate how long the load process did take.
Line 4 removes an environment setting that prints rather annoying messages when running Java.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>set -o errexit -o pipefail -o noclobber -o nounset
shopt -s globstar
_ts=$(date +%s.%N)
unset JAVA_TOOL_OPTIONS</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="dependencies">Dependencies</h3>
<div class="paragraph">
<p>The first real action in the load process is the test for core dependencies.
The source block below shows how the loader tests for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>BASH</em> version 4 - needed to use associative arrays (or maps)</p>
</li>
<li>
<p>GNU <em>Getopt</em> - extensively used in the loader and tasks to parse command lines</p>
</li>
<li>
<p><em>bc</em> - a calculator used for calculating execution time of tasks and scenarios</p>
</li>
<li>
<p><em>mktemp</em> - used to create names for temporary directories, required to store runtime configuration information</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
  <td class="code"><pre>if [[ &quot;${BASH_VERSION:0:1}&quot; -lt 4 ]]; then
    printf &quot; ==&gt; no bash version &gt;4, required for associative arrays\n\n&quot;
    exit 12
fi
! getopt --test &gt; /dev/null
if [[ ${PIPESTATUS[0]} -ne 4 ]]; then
    printf &quot; ==&gt; getopt failed, require for command line parsing\n\n&quot;
    exit 13
fi
if [[ ! $(command -v bc) ]]; then
    printf &quot; ==&gt; did not find bc, require for calculations\n\n&quot;
    exit 14
fi
if [[ ! $(command -v mktemp) ]]; then
    printf &quot; ==&gt; did not find mktemp, require to create temporary files and directories\n\n&quot;
    exit 15
fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="core_and_default_settings">Core and default Settings</h3>
<div class="paragraph">
<p>Once all dependencies are satisfied, the loader realizes core settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If not set, then set <code>$FW_HOME</code> (lines 1-4)</p>
</li>
<li>
<p>Source the loaders declaration files (line 6).
This will create the main configuration map called <code>CONFIG_MAP</code> along with the map <code>CONFIG_SRC</code>.</p>
</li>
<li>
<p>Set core variables in the configuration map (lines 7-25):</p>
<div class="ulist">
<ul>
<li>
<p><em>FW_HOME</em> - the home directory of the framework</p>
</li>
<li>
<p><em>RUNNING_IN</em> - set to loader, this will later be changed the <code>shell</code> or <code>task</code> by the shell and tasks</p>
</li>
<li>
<p><em>SYSTEM</em> - to know in which system the framework is running</p>
</li>
<li>
<p><em>CONFIG_FILE</em> - the SKB configuration file</p>
</li>
<li>
<p><em>STRICT</em> - set strict mode to <code>off</code>, at least initially</p>
</li>
<li>
<p><em>APP_MODE</em> - set the default application mode to <code>use</code></p>
</li>
<li>
<p><em>APP_MODE_FLAVOR</em> - set the default flavor of the application mode to <code>std</code> (standard)</p>
</li>
<li>
<p><em>PRINT_MODE</em> - set the default print mode to <code>ansi</code> (for ANSI formatted text with colors and effects)</p>
</li>
<li>
<p>Levels - set the levels for loader, shell, and tasks initially to <code>error</code></p>
</li>
<li>
<p>Quiet - set quiet mode for loader, shell, and tasks to <code>off</code>, i.e. they are <em>not</em> quiet</p>
</li>
<li>
<p><em>SCENARIO_PATH</em> - create an empty path for scenarios</p>
</li>
<li>
<p><em>SHELL_SNP</em> - activate shell prompt</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td>
  <td class="code"><pre>if [[ -z ${FW_HOME:-} ]]; then
    FW_HOME=$(dirname $0)
    FW_HOME=$(cd $FW_HOME/../.. &amp;&amp; pwd)
fi

source $FW_HOME/bin/loader/declare/_include
CONFIG_MAP[&quot;FW_HOME&quot;]=$FW_HOME                      # home of the framework
export FW_HOME
CONFIG_MAP[&quot;RUNNING_IN&quot;]=&quot;loader&quot;                   # we are in the loader, shell/tasks will change this to &quot;shell&quot; or &quot;task&quot;
CONFIG_MAP[&quot;SYSTEM&quot;]=$(uname -s | cut -c1-6)        # set system, e.g. for Cygwin path conversions
CONFIG_MAP[&quot;CONFIG_FILE&quot;]=&quot;$HOME/.skb&quot;              # config file, in user's home directory
CONFIG_MAP[&quot;STRICT&quot;]=off                            # not strict, yet (change with --strict)
CONFIG_MAP[&quot;APP_MODE&quot;]=use                          # default application mode is use, change with --all-mode, --build-mode, --dev-mode
CONFIG_MAP[&quot;APP_MODE_FLAVOR&quot;]=std                   # default application mode flavor is std, change with --install
CONFIG_MAP[&quot;PRINT_MODE&quot;]=ansi                       # default print mode is ansi, change with --print-mode

CONFIG_MAP[&quot;LOADER_LEVEL&quot;]=&quot;error&quot;                  # output level for loader, change with --loader-level, set to &quot;debug&quot; for early code debugging
CONFIG_MAP[&quot;SHELL_LEVEL&quot;]=&quot;error&quot;                   # output level for shell, change with --shell-level
CONFIG_MAP[&quot;TASK_LEVEL&quot;]=&quot;error&quot;                    # output level for tasks, change with --task-level

CONFIG_MAP[&quot;LOADER_QUIET&quot;]=&quot;off&quot;                    # message level for loader, change with --lq
CONFIG_MAP[&quot;SHELL_QUIET&quot;]=&quot;off&quot;                     # message level for shell, change with --sq
CONFIG_MAP[&quot;TASK_QUIET&quot;]=&quot;off&quot;                      # message level for tasks, change with --tq

CONFIG_MAP[&quot;SCENARIO_PATH&quot;]=&quot;&quot;                      # empty scenario path, set from ENV or file (parameter)
CONFIG_MAP[&quot;SHELL_SNP&quot;]=&quot;off&quot;                       # shell shows prompt, change with --snp</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="core_includes">Core Includes</h3>
<div class="paragraph">
<p>Next, some core files from the framework&#8217;s API are loaded.
To makes things simple, the provided <code><em>include</code> files are used to load all API functions.
Error and warning counters are reset, i.e. set to _0</em>.
Finally, the loaders own function for parsing the command line is loaded (line 6).
This only loads the function, it does not actually parse the command line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>source $FW_HOME/bin/api/_include
ConsoleResetErrors
ConsoleResetWarnings

source $FW_HOME/bin/api/describe/_include
source $FW_HOME/bin/loader/init/parse-cli.sh</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="application_flavor_and_name">Application Flavor and Name</h3>
<div class="paragraph">
<p>The next step is to set the flavor and application name/script.
The flavor is any prefix used by the application to identify parameters.
It must be provided by the application (which starts the loader) as the setting <code>__FW_LOADER_FLAVOR</code>.
Once flavor and application settings are realized, the application map and version are loaded (lines 44-51).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td>
  <td class="code"><pre>if [[ -z ${__FW_LOADER_FLAVOR:-} ]]; then
    ConsoleFatal &quot; -&gt;&quot; &quot;interal error: no flavor set&quot;
    printf &quot;\n&quot;
    exit 16
else
    CONFIG_MAP[&quot;FLAVOR&quot;]=$__FW_LOADER_FLAVOR
    CONFIG_SRC[&quot;FLAVOR&quot;]=&quot;E&quot;
    if [[ -z ${CONFIG_MAP[&quot;FLAVOR&quot;]} ]]; then
        ## did not find FLAVOR
        ConsoleFatal &quot; -&gt;&quot; &quot;internal error: did not find setting for flavor&quot;
        printf &quot;\n&quot;
        exit 16
    fi

    FLAVOR_HOME=&quot;${CONFIG_MAP[&quot;FLAVOR&quot;]}_HOME&quot;
    CONFIG_MAP[&quot;APP_HOME&quot;]=${!FLAVOR_HOME:-}
    CONFIG_SRC[&quot;APP_HOME&quot;]=&quot;E&quot;
    if [[ -z ${CONFIG_MAP[&quot;APP_HOME&quot;]:-} ]]; then
        ConsoleFatal &quot; -&gt;&quot; &quot;did not find environment setting for application home, tried \$${CONFIG_MAP[&quot;FLAVOR&quot;]}_HOME&quot;
        printf &quot;\n&quot;
        exit 17
    elif [[ ! -d ${CONFIG_MAP[&quot;APP_HOME&quot;]} ]]; then
        ## found home, but is no directory
        ConsoleFatal &quot; -&gt;&quot; &quot;\$${CONFIG_MAP[&quot;FLAVOR&quot;]}_HOME set as ${CONFIG_MAP[&quot;APP_HOME&quot;]} does not point to a directory&quot;
        printf &quot;\n&quot;
        exit 18
    fi
fi

if [[ -z ${__FW_LOADER_SCRIPTNAME:-} ]]; then
    ConsoleFatal &quot; -&gt;&quot; &quot;interal error: no application script name set&quot;
    printf &quot;\n&quot;
    exit 20
else
    CONFIG_MAP[&quot;APP_SCRIPT&quot;]=${__FW_LOADER_SCRIPTNAME##*/}
fi
if [[ -z &quot;${__FW_LOADER_APPNAME:-}&quot; ]]; then
    ConsoleFatal &quot; -&gt;&quot; &quot;interal error: no application name set&quot;
    printf &quot;\n&quot;
    exit 21
else
    CONFIG_MAP[&quot;APP_NAME&quot;]=$__FW_LOADER_APPNAME
fi
source $FW_HOME/bin/loader/declare/app-maps.sh
if [[ -f ${CONFIG_MAP[&quot;APP_HOME&quot;]}/etc/version.txt ]]; then
    CONFIG_MAP[&quot;APP_VERSION&quot;]=$(cat ${CONFIG_MAP[&quot;APP_HOME&quot;]}/etc/version.txt)
else
    ConsoleFatal &quot; -&gt;&quot; &quot;no application version found, tried \$APP_HOME/etc/version.txt&quot;
    printf &quot;\n&quot;
    exit 22
fi
if [[ -f ${CONFIG_MAP[&quot;FW_HOME&quot;]}/etc/version.txt ]]; then
    CONFIG_MAP[&quot;FW_VERSION&quot;]=$(cat ${CONFIG_MAP[&quot;FW_HOME&quot;]}/etc/version.txt)
else
    ConsoleFatal &quot; -&gt;&quot; &quot;no framework version found, tried \$FW_HOME/etc/version.txt&quot;
    printf &quot;\n&quot;
    exit 22
fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="temporary_directory">Temporary Directory</h3>
<div class="paragraph">
<p>The next step is to test if the temporary directory can be created.
This is important for two reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The directory uses the application flavor in the same, to separate several SKB applications that might be running on the same host</p>
</li>
<li>
<p>In the directory, the loader will safe to runtime configuration.
This is required because associative arrays (or hash maps, or maps), used to store all configuration data, cannot be exported into the <em>bash</em> environment.
Using temporary files is the only way for the loader to share the configuration with the shell, and for the shell to share it with tasks.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
  <td class="code"><pre>if [[ ! -z ${TMP:-} ]]; then
    TMP_DIRECTORY=${TMP}/${CONFIG_MAP[&quot;APP_SCRIPT&quot;]}
else
    TMP_DIRECTORY=${TMPDIR:-/tmp}/${CONFIG_MAP[&quot;APP_SCRIPT&quot;]}
fi
if [[ ! -d $TMP_DIRECTORY ]]; then
    mkdir $TMP_DIRECTORY 2&gt; /dev/null
    __errno=$?
    if [[ $__errno != 0 ]]; then
        ConsoleFatal &quot; -&gt;&quot; &quot;could not create temporary directory $TMP_DIRECTORY, please check owner and permissions&quot;
        printf &quot;\n&quot;
        exit 23
    fi
fi
if [[ ! -w $TMP_DIRECTORY ]]; then
    ConsoleFatal &quot; -&gt;&quot; &quot;cannot write to temporary directory $TMP_DIRECTORY, please check owner and permissions&quot;
    printf &quot;\n&quot;
    exit 24
fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sneak_preview_of_cli_arguments">Sneak Preview of CLI Arguments</h3>
<div class="paragraph">
<p>Next, the loader does a sneak preview inside the command line arguments.
This is done to determine the application mode that might be requested from the command line.
We need to know the requested mode here, before we actually do parse the arguments later.
This is important to load the correct declarations for all elements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre>case &quot;$@&quot; in
    *&quot;-D&quot;* | *&quot;--dev-mode&quot;*)
        CONFIG_MAP[&quot;APP_MODE&quot;]=&quot;dev&quot;
        CONFIG_SRC[&quot;APP_MODE&quot;]=&quot;O&quot;
        ;;
    *&quot;-B&quot;* | *&quot;--build-mode&quot;*)
        CONFIG_MAP[&quot;APP_MODE&quot;]=&quot;build&quot;
        CONFIG_SRC[&quot;APP_MODE&quot;]=&quot;O&quot;
        ;;
    *&quot;-A&quot;* | *&quot;--all-mode&quot;*)
        CONFIG_MAP[&quot;APP_MODE&quot;]=&quot;all&quot;
        CONFIG_SRC[&quot;APP_MODE&quot;]=&quot;O&quot;
        ;;
esac</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="parameter_declarations">Parameter Declarations</h3>
<div class="paragraph">
<p>With the application mode set, the loader can load the parameter declarations.
These declarations can only be loaded from source, i.e. not from an optional cache, since one of the parameters actually sets the cache directory.
Once loaded (line 1), all loaded parameters are processed (line 4).
This function will load values from the environment, then from an optional configuration file, and finally from potentially declared default values.
This function only loads settings, it does not test any of these settings.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>DeclareParameters
if ConsoleHasErrors; then printf &quot;\n&quot;; exit 25; fi
source $FW_HOME/bin/loader/init/process-settings.sh
ProcessSettings</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="option_declarations">Option Declarations</h3>
<div class="paragraph">
<p>Next is the declaration of command line options.
This declaration can be done from cache (if cached) or source (if no cache exists).
Errors here indicate bugs or runtime problems.
Once declared, all options are set to <code>false</code> in the CLI map (lines 8-11).
This allows to test which options have been used as actual arguments when parsing the command line later.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre>if [[ -f ${CONFIG_MAP[&quot;CACHE_DIR&quot;]}/opt-decl.map ]]; then
    ConsoleInfo &quot;--&gt;&quot; &quot;declaring options from cache&quot;
    source ${CONFIG_MAP[&quot;CACHE_DIR&quot;]}/opt-decl.map
else
    DeclareOptions
    if ConsoleHasErrors; then printf &quot;\n&quot;; exit 26; fi
fi
declare -A OPT_CLI_MAP
for ID in ${!DMAP_OPT_ORIGIN[@]}; do
    OPT_CLI_MAP[$ID]=false
done</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="parse_command_line_arguments">Parse Command Line Arguments</h3>
<div class="paragraph">
<p>Now the loader can safely parse the command line arguments.
The parse function does parse for most options, only set options that have no further side effect.
This means that this function does not execute on any option.
This is done later in the load process.
The print mode is immediately set and tested (lines 3-12) to make sure we have a valid setting for it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre>ParseCli $@
if ConsoleHasErrors; then printf &quot;\n&quot;; exit 27; fi
case &quot;${CONFIG_MAP[&quot;PRINT_MODE&quot;]:-}&quot; in
    ansi | text | adoc)
        ConsoleInfo &quot;--&gt;&quot; &quot;found print mode '${CONFIG_MAP[&quot;PRINT_MODE&quot;]}'&quot;
        ;;
    *)
        CONFIG_MAP[&quot;PRINT_MODE&quot;]=ansi
        CONFIG_SRC[&quot;PRINT_MODE&quot;]=
        ConsoleWarn &quot;--&gt;&quot; &quot;unknown print mode '${CONFIG_MAP[&quot;PRINT_MODE&quot;]}', assuming 'ansi'&quot;
        ;;
esac</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="realize_early_exit_options">Realize early Exit Options</h3>
<div class="paragraph">
<p>At this stage, the loader can realize early exit options.
Those are options that do not require any further actions by the loader.
These options include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clean the cache (lines 1-5),</p>
</li>
<li>
<p>Print the help screen (lines 6-9), and</p>
</li>
<li>
<p>Print the application version (lines 10-13)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If any of these options was requested, the loader will exit with code <em>0</em>, success.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre>if [[ ${OPT_CLI_MAP[&quot;clean-cache&quot;]} != false ]]; then
    ConsoleInfo &quot;--&gt;&quot; &quot;cleaning cache and exit&quot;
    source ${CONFIG_MAP[&quot;FW_HOME&quot;]}/bin/loader/options/clean-cache.sh
    exit 0
fi
if [[ ${OPT_CLI_MAP[&quot;help&quot;]} != false ]]; then
    source ${CONFIG_MAP[&quot;FW_HOME&quot;]}/bin/loader/options/help.sh
    exit 0
fi
if [[ ${OPT_CLI_MAP[&quot;version&quot;]} != false ]]; then
    source ${CONFIG_MAP[&quot;FW_HOME&quot;]}/bin/loader/options/version.sh
    exit 0
fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="declarations_for_commands_and_exit_status_codes">Declarations for Commands and Exit Status Codes</h3>
<div class="paragraph">
<p>Now the declarations of shell commands (lines 1-7) and exit codes (lines 8-14) can be loaded, either from cache or source.
Errors here indicate a framework bug or runtime problem, since commands and exit codes are core features and rather static.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre>if [[ -f ${CONFIG_MAP[&quot;CACHE_DIR&quot;]}/cmd-decl.map ]]; then
    ConsoleInfo &quot;--&gt;&quot; &quot;declaring commands from cache&quot;
    source ${CONFIG_MAP[&quot;CACHE_DIR&quot;]}/cmd-decl.map
else
    DeclareCommands
    if ConsoleHasErrors; then printf &quot;\n&quot;; exit 28; fi
fi
if [[ -f ${CONFIG_MAP[&quot;CACHE_DIR&quot;]}/es-decl.map ]]; then
    ConsoleInfo &quot;--&gt;&quot; &quot;declaring exit-status from cache&quot;
    source ${CONFIG_MAP[&quot;CACHE_DIR&quot;]}/es-decl.map
else
    DeclareExitStatus
    if ConsoleHasErrors; then printf &quot;\n&quot;; exit 29; fi
fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dependency_declarations">Dependency Declarations</h3>
<div class="paragraph">
<p>The next step is to load dependency declarations, either from cache or from source.
Errors here can point to a bug in the framework, a problem in the application, or a problem with a dependency declaration itself.
In this step, dependencies are only declared, but not tested, since the loader still does not know which of them are required by tasks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre>if [[ -f ${CONFIG_MAP[&quot;CACHE_DIR&quot;]}/dep-decl.map ]]; then
    ConsoleInfo &quot;--&gt;&quot; &quot;declaring dependencies from cache&quot;
    source ${CONFIG_MAP[&quot;CACHE_DIR&quot;]}/dep-decl.map
else
    ConsoleInfo &quot;--&gt;&quot; &quot;declaring dependencies from source&quot;
    DeclareDependencies
    if ConsoleHasErrors; then printf &quot;\n&quot;; exit 30; fi
fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="task_declarations">Task Declarations</h3>
<div class="paragraph">
<p>This step is probably the most complicated and most important step in the load process.
First, the declarations of tasks are loaded, either from cache or from source (lines 1-8).
Errors here can point to a bug in the framework, a problem in the application, or a problem with a task declaration itself.
Next, the loaded tasks are processed (line 9-11).
This function will take the loaded tasks and test or validate all parameters and dependencies they require.
This process can take some time, especially for testing external dependencies.
Errors tend to indicate configuration or dependency problems, not internal or declaration problems.</p>
</div>
<div class="paragraph">
<p>Some tasks might declare requirements as <em>optional</em>.
Those dependencies only throw warnings in a normal application run.
Only if an application is run in <em>strict</em> mode will those problems throw errors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre>if [[ -f ${CONFIG_MAP[&quot;CACHE_DIR&quot;]}/task-decl.map ]]; then
    ConsoleInfo &quot;--&gt;&quot; &quot;declaring tasks from cache&quot;
    source ${CONFIG_MAP[&quot;CACHE_DIR&quot;]}/task-decl.map
else
    ConsoleInfo &quot;--&gt;&quot; &quot;declaring tasks from source&quot;
    DeclareTasks
    if ConsoleHasErrors; then printf &quot;\n&quot;; exit 31; fi
fi
source $FW_HOME/bin/loader/init/process-tasks.sh
ProcessTasks
if ConsoleHasErrors; then printf &quot;\n&quot;; exit 32; fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scenario_declarations">Scenario Declarations</h3>
<div class="paragraph">
<p>When tasks are declared, the loader can declare all scenarios from the framework and application home as well as the optional scenario path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>ConsoleInfo &quot;--&gt;&quot; &quot;declaring scenarios from source&quot;
DeclareScenarios
if ConsoleHasErrors; then printf &quot;\n&quot;; exit 33; fi
source $FW_HOME/bin/loader/init/process-scenarios.sh
ProcessScenarios
if ConsoleHasErrors; then printf &quot;\n&quot;; exit 34; fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="set_levels">Set Levels</h3>
<div class="paragraph">
<p>The next step is to set the correct levels (log levels) for the loader (the remaining load steps), the shell, and the tasks.
This is done for each level type in separation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td>
  <td class="code"><pre>case &quot;${CONFIG_MAP[&quot;LOADER_LEVEL&quot;]}&quot; in
    off | all | fatal | error | warn-strict | warn | info | debug | trace)
        ;;
    *)
        ConsoleError &quot;--&gt;&quot; &quot;unknown loader-level: ${CONFIG_MAP[&quot;LOADER_LEVEL&quot;]}&quot;
        printf &quot;    use: off, all, fatal, error, warn-strict, warn, info, debug, trace\n\n&quot;
        exit 35
        ;;
esac
case &quot;${CONFIG_MAP[&quot;SHELL_LEVEL&quot;]}&quot; in
    off | all | fatal | error | warn-strict | warn | info | debug | trace)
        ;;
    *)
        ConsoleError &quot;--&gt;&quot; &quot;unknown shell-level: ${CONFIG_MAP[&quot;SHELL_LEVEL&quot;]}&quot;
        printf &quot;    use: off, all, fatal, error, warn-strict, warn, info, debug, trace\n\n&quot;
        exit 36
        ;;
esac
case &quot;${CONFIG_MAP[&quot;TASK_LEVEL&quot;]}&quot; in
    off | all | fatal | error | warn-strict | warn | info | debug | trace)
        ;;
    *)
        ConsoleError &quot;--&gt;&quot; &quot;unknown task-level: ${CONFIG_MAP[&quot;TASK_LEVEL&quot;]}&quot;
        printf &quot;    use: off, all, fatal, error, warn-strict, warn, info, debug, trace\n\n&quot;
        exit 37
        ;;
esac</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="do_exit_options">Do (Exit) Options</h3>
<div class="paragraph">
<p>At this stage, the loader can process most the remaining exit options.
Those are command line options that request some behavior and then should cause the loader to exit.</p>
</div>
<div class="paragraph">
<p>If such options are requested, the loader might provide some information about its execution time (lines 5-11).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre>source $FW_HOME/bin/loader/init/do-options.sh
DoOptions
if ConsoleHasErrors; then printf &quot;\n&quot;; exit 38; fi

if [[ $DO_EXIT == true ]]; then
    _te=$(date +%s.%N)
    _exec_time=$_te-$_ts
    ConsoleInfo &quot;--&gt;&quot; &quot;execution time: $(echo $_exec_time | bc -l) sec&quot;
    ConsoleInfo &quot;--&gt;&quot; &quot;done&quot;
    exit 0
fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create_runtime_configuration_file">Create Runtime Configuration File</h3>
<div class="paragraph">
<p>Now, the loader needs to create the temporary runtime configuration file.
The remaining actions are either to run a execute a task, run a scenario, or execute the interactive shell.
All of these actions require the configuration to be available.
The configuration file is created in the already tested directory, usually located in <code>/tmp/</code>.
The name of the configuration files includes a time stamp of its creation and an arbitrary, random string.
<code>mktemp</code> is used to create the file name.
Since the name is unique, the same application can be executed many times simultaneously.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>CONFIG_MAP[&quot;FW_L1_CONFIG&quot;]=$(mktemp &quot;$TMP_DIRECTORY/$(date +&quot;%H-%M-%S&quot;)-${CONFIG_MAP[&quot;APP_MODE&quot;]}-XXX&quot;)
export FW_L1_CONFIG=${CONFIG_MAP[&quot;FW_L1_CONFIG&quot;]}
WriteRuntimeConfig</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="execute_task_or_scenario">Execute Task or Scenario</h3>
<div class="paragraph">
<p>The final exit options are to execute a task or to run a scenario.
The loader will try either of them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
  <td class="code"><pre>__errno=0
if [[ &quot;${OPT_CLI_MAP[&quot;execute-task&quot;]}&quot; != false ]]; then
    echo ${OPT_CLI_MAP[&quot;execute-task&quot;]} | $FW_HOME/bin/shell/shell.sh
    __et=$?
    __errno=$((__errno + __et))
fi
if [[ &quot;${OPT_CLI_MAP[&quot;run-scenario&quot;]}&quot; != false ]]; then
    echo &quot;execute-scenario ${OPT_CLI_MAP[&quot;run-scenario&quot;]}&quot; | $FW_HOME/bin/shell/shell.sh
    __et=$?
    __errno=$((__errno + __et))
    DO_EXIT_2=true
fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="start_shell">Start Shell</h3>
<div class="paragraph">
<p>This is the final step of the load process.
If no task or scenario was requested to be executed, the loader will start the interactive shell.
This shell will run until a user caused it or exit, or until an error terminated the whole application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>if [[ ${DO_EXIT_2} == false ]]; then
    $FW_HOME/bin/shell/shell.sh
    __errno=$?
fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clean_up">Clean Up</h3>
<div class="paragraph">
<p>Finally, the loader can cleanup and prepare to terminate.
Cleanup basically means to remove the temporary configuration file.
If the temporary directory is no longer needed, i.e. no other configuration exists in it, it can be removed as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>if [[ -f $FW_L1_CONFIG ]]; then
    rm $FW_L1_CONFIG &gt;&amp; /dev/null
fi
if [[ -d $TMP_DIRECTORY &amp;&amp; $(ls $TMP_DIRECTORY | wc -l) == 0 ]]; then
    rmdir $TMP_DIRECTORY
fi</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="done">Done</h3>
<div class="paragraph">
<p>The loader is done, all actions have been taken.
It now can safely exit and return the execution to the <code>skb-framework</code> or the calling application.
A final message is displayed to mark this point in the process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>ConsoleMessage &quot;\n\nhave a nice day\n\n\n&quot;
exit $__errno</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                          <p>
                    Copyright &copy; 2018 Sven van der Meer. All rights reserved.
                </p>
                <p>
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.
                </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
